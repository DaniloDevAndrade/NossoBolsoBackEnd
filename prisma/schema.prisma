generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String   @unique
  password  String
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  whatsappCodes WhatsappCode[]

  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)

  sentRequests     PartnerRequest[] @relation("RequestSender")
  receivedRequests PartnerRequest[] @relation("RequestReceiver")

  expensesCreated Expense[] @relation("ExpenseCreator")
  incomesCreated  Income[]  @relation("IncomeCreator")

  expensesResponsible Expense[] @relation("ExpenseResponsible")
  incomesResponsible  Income[]  @relation("IncomeResponsible")

  creditCards       CreditCard[]
  goalContributions GoalContribution[]

  @@index([email])
  @@index([phone])
}

model WhatsappCode {
  id String @id @default(uuid())

  userPhone String
  user      User   @relation(fields: [userPhone], references: [phone])

  codeHash  String
  type      String
  used      Boolean  @default(false)
  expiresAt DateTime
  attempts  Int      @default(0)

  challengeId String? @unique

  createdAt DateTime @default(now())

  @@index([userPhone, type, used])
}

model Account {
  id   String @id @default(cuid())
  type String @default("couple")

  trialEndsAt        DateTime  @default(dbgenerated("NOW() + INTERVAL '30 days'"))
  subscriptionStatus String    @default("trial")
  subscriptionEndsAt DateTime?

  users           User[]
  partnerRequests PartnerRequest[]

  expenses    Expense[]
  incomes     Income[]
  creditCards CreditCard[]

  goals             Goal[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  goalContributions GoalContribution[]
}

model PartnerRequest {
  id String @id @default(cuid())

  senderId String
  sender   User   @relation("RequestSender", fields: [senderId], references: [id], onDelete: Cascade)

  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  receiverPhone String
  receiverId    String?
  receiver      User?   @relation("RequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  status     String  @default("pending")
  inviteCode String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([receiverPhone])
  @@index([inviteCode])
  @@index([accountId])
}

model Expense {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  createdById String
  createdBy   User   @relation("ExpenseCreator", fields: [createdById], references: [id])

  responsibleUserId String?
  responsibleUser   User?   @relation("ExpenseResponsible", fields: [responsibleUserId], references: [id])

  description String
  category    String
  value       Float
  date        DateTime @db.Date

  paidBy String?

  youPay      Float?
  partnerPays Float?

  paymentMethod String

  cardId String?
  card   CreditCard? @relation(fields: [cardId], references: [id])

  installments       Int?
  currentInstallment Int?
  installment        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Income {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  createdById String
  createdBy   User   @relation("IncomeCreator", fields: [createdById], references: [id])

  responsibleUserId String?
  responsibleUser   User?   @relation("IncomeResponsible", fields: [responsibleUserId], references: [id])

  description String
  category    String
  value       Float
  date        DateTime @db.Date

  receivedBy     String?
  youReceive     Float?
  partnerReceive Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum CreditCardInstitution {
  NUBANK
  INTER
  ITAU
  BANCO_DO_BRASIL
  BRADESCO
  SANTANDER
  CAIXA
  BTG_PACTUAL
  C6_BANK
  PAGBANK
  OUTROS
}

model CreditCard {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  institution CreditCardInstitution
  lastDigits  String
  limit       Float
  dueDay      Int
  closingDay  Int?

  owner String @default("user")

  expenses Expense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([userId])
  @@index([owner])
}

model Goal {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  name        String
  description String?

  target Float

  monthlyContribution Float @default(0)

  deadline DateTime @db.Date

  contributions GoalContribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
  @@index([deadline])
}

model GoalContribution {
  id String @id @default(cuid())

  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  amount Float
  date   DateTime @db.Date

  source String @default("user")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([goalId])
  @@index([accountId])
  @@index([createdById])
  @@index([date])
  @@index([source])
}
